import { isAudioBufferSourceNode } from 'standardized-audio-context/src/guards/audio-buffer-source-node';
import { isAudioWorkletNode } from 'standardized-audio-context/src/guards/audio-worklet-node';
import { isBiquadFilterNode } from 'standardized-audio-context/src/guards/biquad-filter-node';
import { isConstantSourceNode } from 'standardized-audio-context/src/guards/constant-source-node';
import { isGainNode } from 'standardized-audio-context/src/guards/gain-node';
import { isOscillatorNode } from 'standardized-audio-context/src/guards/oscillator-node';
import { isStereoPannerNode } from 'standardized-audio-context/src/guards/stereo-panner-node';
import { IAudioNode } from 'standardized-audio-context/src/interfaces/index';
import { TContext } from 'standardized-audio-context/src/types/index';
import { getAudioNodeConnections } from 'standardized-audio-context/src/helpers/get-audio-node-connections';
import { getAudioParamConnections } from 'standardized-audio-context/src/helpers/get-audio-param-connections';
import { isActiveAudioNode } from 'standardized-audio-context/src/helpers/is-active-audio-node';
import { setInternalStateToPassive } from 'standardized-audio-context/src/helpers/set-internal-state-to-passive';

export const deactivateActiveAudioNodeInputConnections = <T extends TContext>(
    audioNode: IAudioNode<T>,
    trace: readonly IAudioNode<T>[]
) => {
    const { activeInputs } = getAudioNodeConnections(audioNode);

    activeInputs.forEach((connections) =>
        connections.forEach(([source]) => {
            if (!trace.includes(audioNode)) {
                deactivateActiveAudioNodeInputConnections(source, [...trace, audioNode]);
            }
        })
    );

    const audioParams = isAudioBufferSourceNode(audioNode)
        ? [
              // Bug #149: Safari does not yet support the detune AudioParam.
              audioNode.playbackRate
          ]
        : isAudioWorkletNode(audioNode)
        ? Array.from(audioNode.parameters.values())
        : isBiquadFilterNode(audioNode)
        ? [audioNode.Q, audioNode.detune, audioNode.frequency, audioNode.gain]
        : isConstantSourceNode(audioNode)
        ? [audioNode.offset]
        : isGainNode(audioNode)
        ? [audioNode.gain]
        : isOscillatorNode(audioNode)
        ? [audioNode.detune, audioNode.frequency]
        : isStereoPannerNode(audioNode)
        ? [audioNode.pan]
        : [];

    for (const audioParam of audioParams) {
        const audioParamConnections = getAudioParamConnections<T>(audioParam);

        if (audioParamConnections !== undefined) {
            audioParamConnections.activeInputs.forEach(([source]) => deactivateActiveAudioNodeInputConnections(source, trace));
        }
    }

    if (isActiveAudioNode(audioNode)) {
        setInternalStateToPassive(audioNode);
    }
};
