import { NODE_TO_PROCESSOR_MAPS } from 'standardized-audio-context/src/globals';
import { IAudioWorkletNodeOptions, IAudioWorkletProcessor, IAudioWorkletProcessorConstructor } from 'standardized-audio-context/src/interfaces/index';
import { TNativeAudioWorkletNode, TNativeContext } from 'standardized-audio-context/src/types/index';
import { createAudioWorkletProcessorPromise } from 'standardized-audio-context/src/helpers/create-audio-worklet-processor-promise';

export const createAudioWorkletProcessor = (
    nativeContext: TNativeContext,
    nativeAudioWorkletNode: TNativeAudioWorkletNode,
    processorConstructor: IAudioWorkletProcessorConstructor,
    audioWorkletNodeOptions: IAudioWorkletNodeOptions
): Promise<IAudioWorkletProcessor> => {
    let nodeToProcessorMap = NODE_TO_PROCESSOR_MAPS.get(nativeContext);

    if (nodeToProcessorMap === undefined) {
        nodeToProcessorMap = new WeakMap();

        NODE_TO_PROCESSOR_MAPS.set(nativeContext, nodeToProcessorMap);
    }

    const audioWorkletProcessorPromise = createAudioWorkletProcessorPromise(processorConstructor, audioWorkletNodeOptions);

    nodeToProcessorMap.set(nativeAudioWorkletNode, audioWorkletProcessorPromise);

    return audioWorkletProcessorPromise;
};
