import { IAudioNode } from 'standardized-audio-context/src/interfaces/index';
import { TActiveInputConnection, TContext, TPassiveAudioParamInputConnection } from 'standardized-audio-context/src/types/index';
import { insertElementInSet } from 'standardized-audio-context/src/helpers/insert-element-in-set';

export const addPassiveInputConnectionToAudioParam = <T extends TContext>(
    passiveInputs: WeakMap<IAudioNode<T>, Set<TPassiveAudioParamInputConnection>>,
    [source, output, eventListener]: TActiveInputConnection<T>,
    ignoreDuplicates: boolean
) => {
    const passiveInputConnections = passiveInputs.get(source);

    if (passiveInputConnections === undefined) {
        passiveInputs.set(source, new Set([[output, eventListener]]));
    } else {
        insertElementInSet(
            passiveInputConnections,
            [output, eventListener],
            (passiveInputConnection) => passiveInputConnection[0] === output,
            ignoreDuplicates
        );
    }
};
